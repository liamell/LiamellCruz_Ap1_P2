@page "/Combo/Create"
@using LiamellCruz_Ap1_P2.Models
@using LiamellCruz_Ap1_P2.Service
@using System.Linq;
@inject ToastService Toast
@inject ComboService comboService
@inject ArticuloService articuloService
@inject ComboDetalleService combodetalleService
@inject NavigationManager navigationManager
@rendermode InteractiveServer

<Toasts class="p-3" AutoHide="true" Delay="2000" Placement="ToastsPlacement.TopRight" />

<PageTitle>Create</PageTitle>
<EditForm Model="Combo" OnValidSubmit="Guardar">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="container">
        <div class="card shadow-lg">
            <div class="card-header">
                <h5 class="card-title">Crear Combo</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label"><strong>ComboId</strong></label>
                    <InputNumber class="form-control" @bind-Value="Combo.ComboId" readonly></InputNumber>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>Fecha</strong></label>
                    <InputDate class="form-control" @bind-Value="Combo.Fecha"></InputDate>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>Descripción</strong></label>
                    <InputText class="form-control" @bind-Value="Combo.Descripcion"></InputText>
                </div>
               

                <div class="border border-success p-3 mt-3">
                    <h5>Detalles de artículos utilizados</h5>
                    <div class="row">
                        <div class="col-auto">
                            <AgregarArticulos ListaArticulo="ListaArticulo"
                                              ArticuloId="ComboDetalle.ArticuloId"
                                              Cantidad="ComboDetalle.Cantidad"
                                              Costo="ComboDetalle.Costo"
                                              ProductosSeleccionado="AgregarDetalle" />
                        </div>
                    </div>
                    <ul class="mt-3">
                        @foreach (var detalle in Combo.ComboDetalle)
                        {
                            <li class="mt-2">
                                Articulo ID: @detalle.ArticuloId -- @detalle.Articulo?.Descripcion -- Cantidad: @detalle.Cantidad -- Costo Total: $ @detalle.Costo
                                <button type="button" @onclick="() => Eliminar(detalle)" class="btn btn-outline-danger btn-sm ms-2 bi bi-trash"></button>
                            </li>
                        }
                    </ul>
                </div>
            </div>
            <div class="card-footer text-center mt-2">
                <a href="/Combo/Index" class="btn btn-secondary"> <span class="bi bi-arrow-left"></span> Volver</a>
                <button type="submit" class="btn btn-success bi bi-floppy-fill">Guardar</button>
            </div>
        </div>
    </div>
</EditForm>

@Mensaje

@code {
    public Combo Combo { get; set; } = new Combo();
    public string Mensaje { get; set; } = string.Empty;
    public List<Articulo> ListaArticulo { get; set; } = new List<Articulo>();
    public ComboDetalle ComboDetalle { get; set; } = new ComboDetalle();

    protected override async Task OnInitializedAsync()
    {
        ListaArticulo = await articuloService.Listar(a => a.ArticuloId > 0);
    }

    public async Task<bool> Validar()
    {
        var valido = await comboService.Existe(Combo.ComboId);
        return valido;
    }

    private async Task AgregarDetalle((Articulo articulo, int Cantidad) selection)
    {
        // Busca si ya existe un detalle para el artículo seleccionado
        var ArticuloExiste = Combo.ComboDetalle.FirstOrDefault(A => A.ArticuloId == selection.articulo.ArticuloId);

        if (ArticuloExiste != null)
        {
            // Si el artículo ya está en los detalles, actualiza la cantidad y el costo
            ArticuloExiste.Cantidad += selection.Cantidad;
            ArticuloExiste.Costo = selection.articulo.Costo * ArticuloExiste.Cantidad;
        }
        else
        {
            // Asegúrate de que el artículo seleccionado tiene un costo válido
            if (selection.articulo.Costo <= 0)
            {
                Toast.Notify(new ToastMessage(ToastType.Danger, $"El artículo seleccionado no tiene un costo válido."));
                return;
            }

            // Crea un nuevo detalle
            var nuevoDetalle = new ComboDetalle
                {
                    ArticuloId = selection.articulo.ArticuloId,
                    Cantidad = selection.Cantidad,
                    Costo = selection.articulo.Costo * selection.Cantidad,
                    Articulo = selection.articulo // Relaciona el artículo completo
                };

            Combo.ComboDetalle.Add(nuevoDetalle);
        }

        await Task.CompletedTask;
    }







    private async Task Guardar()
    {
        if (await Validar())
        {
            Toast.Notify(new ToastMessage(ToastType.Danger, $"Ya existe un combo con este ID"));
            return;
        }

        if (Combo.ComboDetalle == null || !Combo.ComboDetalle.Any())
        {
            Toast.Notify(new ToastMessage(ToastType.Warning, $"El combo no tiene detalles. Agregue al menos un artículo."));
            return;
        }

        // Calcula el precio total del combo
        Combo.Precio = Combo.ComboDetalle.Sum(d => d.Costo);

        if (Combo.Precio <= 0)
        {
            Toast.Notify(new ToastMessage(ToastType.Warning, $"El combo no tiene un precio válido."));
            return;
        }

        // Guarda el combo
        var crear = await comboService.Guardar(Combo);

        if (crear)
        {
            Toast.Notify(new ToastMessage(ToastType.Success, $"Creado correctamente"));
            await Task.Delay(2000);
            navigationManager.NavigateTo("/Combo/Index");
        }
        else
        {
            Toast.Notify(new ToastMessage(ToastType.Danger, $"No se ha creado correctamente"));
        }
    }



    public async Task Eliminar(ComboDetalle detalle)
    {
        var resultado = await combodetalleService.Eliminar(detalle.DetalleId);

        if (resultado)
        {
            Combo.ComboDetalle.Remove(detalle);
            ComboDetalle.Cantidad = detalle.Cantidad;
            ComboDetalle.ArticuloId = detalle.ArticuloId;

            Toast.Notify(new ToastMessage(ToastType.Success, $"Producto eliminado correctamente"));
        }
        else
        {
            Toast.Notify(new ToastMessage(ToastType.Danger, $"Error al eliminar el producto"));
        }
    }

}